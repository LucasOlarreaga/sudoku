<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sudoku Puzzles</title>
    <style>
      html {
        background-color: rgb(188, 225, 239);
      }

      h1 {
        font-size: 31px;
        text-align: center;
        color: rgb(14, 111, 96);
      }

      .button-container {
        text-align: center;
        margin-top: 20px;
      }

      .button-container button {
        text-align: center;
        color: white;
        border: none;
        font-size: small;
        background-color: rgb(76, 134, 126);
        font-size: 16px;
        border-radius: 15px;
        cursor: pointer;
        transition: 1s;
        height: 35px;
        width: 60px;
        margin-right: 20px;
      }

      #container {
        display: flex;
        justify-content: center;
        align-items: center;
        margin: 20px auto; /* Center the container */
        position: relative; /* Relative positioning for child elements */
      }

      info-container {
        display: flex;
        flex-direction: column; /* Ensures vertical stacking */
        align-items: center; /* Centers both lives and hints horizontally */
      }

      table {
        border-collapse: collapse;
        font-size: 20px;
        background-color: white;
      }

      td {
        width: 40px;
        height: 40px;
        text-align: center;
        font-family: "Comic Sans MS", sans-serif;
        border: 1px solid #000;
        padding: 0;
      }

      input {
        width: 100%;
        height: 100%;
        text-align: center;
        font-family: "Comic Sans MS", sans-serif;
        color: rgb(14, 95, 122);
        font-size: 20px;
        border: none;
        box-sizing: border-box;
      }

      .incorrect {
        background-color: red;
        color: white;
      }

      tr:nth-child(3) td,
      tr:nth-child(6) td {
        border-bottom: 2px solid #000;
      }

      td:nth-child(3),
      td:nth-child(6) {
        border-right: 2px solid #000;
      }

      input[type="number"] {
        -moz-appearance: textfield;
        appearance: textfield;
      }

      input[type="number"]::-webkit-outer-spin-button,
      input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      #lives-container,
      #hints-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
        font-size: 24px; /* Adjust size to preference */
      }

      #lives-container {
        margin-left: 12px; /* Space between grid and hearts */
      }

      #hints-container {
        margin-top: 70px;
        margin-left: 12px; /* Space between hearts and hints */
      }

      .life,
      .hint {
        cursor: pointer;
        transition: opacity 0.3s ease;
      }

      .life.used,
      .hint.used {
        opacity: 0.2; /* Makes it look "faded" when used */
      }
    </style>
    <h1>Sudoku Puzzle</h1>
  </head>
  <body>
    <div id="container">
      <table>
        {% set indices = get_row_col_indices(puzzle) %} {% for row_index in
        range(puzzle|length) %}
        <tr>
          {% for col_index in range(puzzle[row_index]|length) %}
          <td>
            {% if puzzle[row_index][col_index] == 0 %}
            <input
              type="tel"
              pattern="[0-9]*"
              inputmode="numeric"
              maxlength="1"
              class="sudoku-input"
              data-row="{{ row_index + 1 }}"
              data-col="{{ col_index + 1 }}"
              oninput="checkInput(this)"
            />
            {% else %} {{ puzzle[row_index][col_index] }} {% endif %}
          </td>
          {% endfor %}
        </tr>
        {% endfor %}
      </table>
      <div id="info-container">
        <div id="lives-container">
          {% for i in range(lives) %}
          <span class="life">‚ù§Ô∏è</span>
          {% endfor %}
        </div>

        <div id="hints-container">
          {% for i in range(hints) %}
          <span class="hint">üîç</span>
          {% endfor %}
        </div>
      </div>
    </div>

    <input type="hidden" id="answer" value="{{ answer | tojson }}" />
    <div
      id="message"
      style="text-align: center; margin-top: 20px; font-size: 20px"
    ></div>

    <div class="button-container">
      <button onclick="newPuzzle()">New</button>
      <button onclick="revealNumber()">Hint</button>
    </div>

    <script>
      // Initialize lives variable
      let lives = parseInt(
        document.querySelector("span#lives")?.textContent || "3",
        10
      );
      let hints = parseInt(
        document.querySelector("span#hints")?.textContent || "3",
        10
      );

      // Update lives and hearts
      function updateLives(newLives) {
        lives = newLives;
        const hearts = Array.from(document.querySelectorAll(".life")).reverse(); // Reverse the order of hearts

        // Update lives by marking the top hearts as used
        hearts.forEach((heart, index) => {
          if (index < lives) {
            heart.classList.remove("used"); // Keep the first few hearts active
          } else {
            heart.classList.add("used"); // Mark the rest as used
          }
        });

        // Check for game over
        if (lives <= 0) {
          document.getElementById("message").textContent =
            "Game Over! You've lost all your lives.";
          document.getElementById("message").style.color = "red";
          disableAllInputs();
        }
      }

      function loseLife() {
        updateLives(lives - 1); // Decrement lives and update UI
      }

      // Make sure to update the initial number of lives on page load
      document.addEventListener("DOMContentLoaded", () => {
        updateLives(lives);
      });

      function checkInput(input) {
        const value = input.value;
        const row = input.getAttribute("data-row");
        const col = input.getAttribute("data-col");

        if (value && (value < 1 || value > 9)) {
          input.value = "";
          return;
        }

        // Remove the "incorrect" class if the input is cleared
        if (!value) {
          input.classList.remove("incorrect");
          return; // Exit if the input is empty
        }

        fetch("/check_number", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            row: row,
            col: col,
            number: value,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.correct) {
              input.classList.remove("incorrect");
              checkCompletion(); // Check if the puzzle is completed correctly
            } else {
              input.classList.add("incorrect");
              updateLives(data.lives);
            }
          });
      }

      function checkCompletion() {
        let board = [];
        document.querySelectorAll("tr").forEach((row, i) => {
          let rowArr = [];
          row.querySelectorAll("td").forEach((cell, j) => {
            let value = cell.querySelector("input")
              ? cell.querySelector("input").value
              : cell.textContent;
            rowArr.push(value === "" ? 0 : parseInt(value));
          });
          board.push(rowArr);
        });

        const answer = JSON.parse(document.getElementById("answer").value);

        // Check if the current board matches the answer
        const isCompleted = board.every((row, i) =>
          row.every((cell, j) => cell === answer[i][j])
        );

        if (isCompleted) {
          document.getElementById("message").textContent =
            "Well Done! You've solved the Sudoku!";
          document.getElementById("message").style.color = "green";
          disableAllInputs();
        }
      }

      function disableAllInputs() {
        document.querySelectorAll("input").forEach((input) => {
          input.disabled = true;
        });
      }

      function newPuzzle() {
        location.reload();
      }

      function revealNumber() {
        const answer = JSON.parse(document.getElementById("answer").value);
        let board = [];

        document.querySelectorAll("tr").forEach((row, i) => {
          let rowArr = [];
          row.querySelectorAll("td").forEach((cell, j) => {
            let value = cell.querySelector("input")
              ? cell.querySelector("input").value
              : cell.textContent;
            rowArr.push(value === "" ? 0 : parseInt(value));
          });
          board.push(rowArr);
        });

        // Find all empty cells
        let emptyCells = [];
        for (let i = 0; i < 9; i++) {
          for (let j = 0; j < 9; j++) {
            if (board[i][j] === 0) {
              emptyCells.push({ row: i, col: j });
            }
          }
        }

        // If there are no empty cells, no hint can be given
        let n_hints_used = Array.from(document.querySelectorAll(".hint.used"));
        if (emptyCells.length < 2 || n_hints_used.length === 3) {
          document.getElementById("message").textContent =
            "No more hints available!";
          document.getElementById("message").style.color = "purple";
          return;
        } else {
          useHint();
        }

        // Select a random empty cell
        const randomIndex = Math.floor(Math.random() * emptyCells.length);
        const cell = emptyCells[randomIndex];

        // Reveal the correct number in that cell
        const correctNumber = answer[cell.row][cell.col];
        board[cell.row][cell.col] = correctNumber;

        // Update the UI
        const cellElement = document
          .querySelectorAll("tr")
          [cell.row].querySelectorAll("td")[cell.col];
        if (cellElement.querySelector("input")) {
          cellElement.querySelector("input").value = correctNumber;
          cellElement.querySelector("input").disabled = true; // Disable input to indicate it's revealed
          cellElement.querySelector("input").style.color = "blue"; // Color hint numbers differently
        } else {
          cellElement.textContent = correctNumber;
        }
      }

      function useHint() {
        // Ensure hints is correctly defined and updated elsewhere in your code
        let hints = Array.from(document.querySelectorAll(".hint:not(.used)")); // Grab non-used hints

        if (hints.length > 0) {
          let hint = hints[0]; // Removes the top hint
          hint.classList.add("used");
        }
      }
    </script>
  </body>
</html>
